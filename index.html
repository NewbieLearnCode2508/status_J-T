<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Qu·∫£n l√Ω ƒë∆°n h√†ng J&T</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        background: #eef1f7;
        font-family: "Inter", sans-serif;
      }

      .card {
        border: none;
        border-radius: 18px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
      }

      #loginBox {
        max-width: 400px;
        margin: auto;
        margin-top: 120px;
      }

      .hidden {
        display: none;
      }

      .stat {
        font-size: 32px;
        font-weight: 700;
        color: #4c7cf0;
      }

      .upload-box {
        border: 2px dashed #ccc;
        padding: 30px;
        border-radius: 12px;
        text-align: center;
        cursor: pointer;
        background: white;
      }

      .upload-box:hover {
        border-color: #4c7cf0;
      }

      table {
        border-radius: 12px;
        overflow: hidden;
      }

      th {
        font-weight: 600;
        letter-spacing: 0.3px;
      }

      td {
        vertical-align: middle;
      }

      tbody tr:hover {
        background: #f2f6ff;
        transition: 0.2s;
      }
    </style>
  </head>
  <body>
    <!-- LOGIN -->
    <div id="loginBox" class="card p-4">
      <h3 class="text-center mb-3">Employee Login</h3>

      <input id="email" class="form-control mb-2" placeholder="Email" />
      <input
        id="password"
        type="password"
        class="form-control mb-3"
        placeholder="Password"
      />

      <button onclick="login()" class="btn btn-primary w-100">Login</button>

      <p id="loginError" class="text-danger mt-2"></p>
    </div>

    <!-- DASHBOARD -->
    <div id="app" class="container hidden">
      <div class="d-flex justify-content-between align-items-center mt-4">
        <h2>Dashboard ƒë∆°n h√†ng</h2>
        <button class="btn btn-danger" onclick="logout()">Logout</button>
      </div>

      <!-- STATS -->
      <div class="row mt-4">
        <div class="col-md-4">
          <div class="card p-3">
            T·ªïng ƒë∆°n
            <div id="totalOrders" class="stat">0</div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card p-3">
            T·ªïng COD
            <div id="totalCOD" class="stat">0</div>
          </div>
        </div>
      </div>

      <!-- UPLOAD -->
      <div class="upload-box mt-4">
        <input type="file" id="upload" hidden />
        <h5>Click ƒë·ªÉ upload Excel</h5>
        <small>.xlsx / .xls</small>
      </div>

      <!-- SEARCH -->
      <div class="card p-3 mt-4">
        <div class="row g-2">
          <div class="row mt-4">
            <div class="col-md-4">
              <input
                id="search"
                class="form-control"
                placeholder="Search m√£ v·∫≠n ƒë∆°n / SƒêT / t√™n..."
                onkeyup="applyFilters()"
              />
            </div>

            <div class="col-md-3">
              <select
                id="statusFilter"
                class="form-control"
                onchange="applyFilters()"
              >
                <option value="">-- L·ªçc tr·∫°ng th√°i --</option>
                <option value="ƒê√£ giao">ƒê√£ giao</option>
                <option value="ƒêang giao">ƒêang giao</option>
                <option value="Ho√†n">Ho√†n</option>
              </select>
            </div>
            <div class="col-md-3">
              <select
                id="senderFilter"
                class="form-control"
                onchange="applyFilters()"
              >
                <option value="">-- L·ªçc kho g·ª≠i --</option>
              </select>
            </div>
          </div>

          <div id="pagination" class="mt-3"></div>

          <div class="col-md-3">
            <input
              id="fromDate"
              type="date"
              class="form-control"
              onchange="applyFilters()"
            />
          </div>

          <div class="col-md-3">
            <input
              id="toDate"
              type="date"
              class="form-control"
              onchange="applyFilters()"
            />
          </div>
        </div>
      </div>

      <!-- TABLE -->
      <div class="table-responsive mt-3">
        <table class="table table-bordered" id="table"></table>
      </div>
    </div>

    <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
      import * as XLSX from "https://esm.sh/xlsx";

      /* üî• THAY 2 GI√Å TR·ªä N√ÄY */
      const supabaseUrl = "https://srfwtdxjmtvkxkpnixay.supabase.co";
      const supabaseKey =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNyZnd0ZHhqbXR2a3hrcG5peGF5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMzMzMDUsImV4cCI6MjA4NTkwOTMwNX0.fZA6NVM4Fh_E6iK_n7XHQXKigSN0wYZu-qjKkwJ72Dg";

      const supabase = createClient(supabaseUrl, supabaseKey);

      window.orders = [];
      window.filteredOrders = [];
      window.currentPage = 1;

      const PAGE_SIZE = 40;

      /* ================= LOGIN ================= */

      async function checkUser() {
        const {
          data: { session },
        } = await supabase.auth.getSession();

        if (session) {
          showApp();
          loadOrders();
          realtime();
        }
      }

      checkUser();

      window.login = async function () {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;

        const { error } = await supabase.auth.signInWithPassword({
          email,
          password,
        });

        if (error) {
          document.getElementById("loginError").innerText = error.message;
          return;
        }

        showApp();
        loadOrders();
        realtime();
      };

      window.logout = async function () {
        await supabase.auth.signOut();
        location.reload();
      };

      async function showApp() {
        document.getElementById("loginBox").classList.add("hidden");
        document.getElementById("app").classList.remove("hidden");

        // üî• L·∫§Y ROLE
        const { data, error } = await supabase
          .from("profiles")
          .select("role")
          .single();

        if (error) {
          console.error(error);
          return;
        }

        // N·∫øu kh√¥ng ph·∫£i admin -> ·∫©n upload
        if (data.role !== "admin") {
          document.querySelector(".upload-box").style.display = "none";
        }
      }

      /* ================= FILTERS ================= */
      window.applyFilters = function () {
        const keyword = document.getElementById("search").value.toLowerCase();
        const status = document.getElementById("statusFilter").value;
        const sender = document.getElementById("senderFilter").value;

        const from = document.getElementById("fromDate").value;
        const to = document.getElementById("toDate").value;

        window.filteredOrders = window.orders.filter((o) => {
          // search
          const matchKeyword = Object.values(o)
            .join(" ")
            .toLowerCase()
            .includes(keyword);

          // status
          const matchStatus =
            !status ||
            (o.trang_thai || "").trim().toLowerCase() ===
              status.trim().toLowerCase();

          // date
          let matchDate = true;

          if (from || to) {
            const orderDate = new Date(o.thoi_gian_tao_don);

            if (from && orderDate < new Date(from)) matchDate = false;

            if (to) {
              const toDate = new Date(to);
              toDate.setHours(23, 59, 59);

              if (orderDate > toDate) matchDate = false;
            }
          }

          const matchSender =
            !sender ||
            (o.ten_nguoi_gui || "").trim().toLowerCase() ===
              sender.trim().toLowerCase();

          return matchKeyword && matchStatus && matchDate && matchSender;
        });

        window.currentPage = 1;

        renderTable();
        renderPagination();
      };

      /* ================= PAGINATION ================= */
      function renderPagination() {
        const totalPages = Math.ceil(filteredOrders.length / PAGE_SIZE);

        const container = document.getElementById("pagination");

        let html = `<nav><ul class="pagination">`;

        for (let i = 1; i <= totalPages; i++) {
          html += `
              <li class="page-item ${i === currentPage ? "active" : ""}">
                  <button class="page-link"
                      onclick="goToPage(${i})">
                      ${i}
                  </button>
              </li>`;
        }

        html += "</ul></nav>";

        container.innerHTML = html;
      }

      window.goToPage = function (page) {
        currentPage = page;
        renderTable();
      };

      /* ================= LOAD DATA ================= */

      async function loadOrders() {
        const { data, error } = await supabase
          .from("orders")
          .select("*")
          .order("thoi_gian_tao_don", { ascending: false });

        if (error) {
          alert(error.message);
          return;
        }

        window.orders = data;
        buildStatusFilter(data);
        buildSenderFilter(data);
        applyFilters();
        renderStats(data);
      }

      /* ================= BUILD STATUS FILTER ================= */
      function buildStatusFilter(data) {
        const statuses = [
          ...new Set(data.map((o) => (o.trang_thai || "").trim())),
        ].sort();

        const select = document.getElementById("statusFilter");

        select.innerHTML = `<option value="">-- L·ªçc tr·∫°ng th√°i --</option>`;

        statuses.forEach((s) => {
          select.innerHTML += `<option value="${s}">${s}</option>`;
        });
      }
      /* ================= BUILD SENDER FILTER ================= */
      function buildSenderFilter(data) {
        const senders = [
          ...new Set(data.map((o) => (o.ten_nguoi_gui || "").trim())),
        ].sort();

        const select = document.getElementById("senderFilter");

        select.innerHTML = `<option value="">-- L·ªçc kho g·ª≠i --</option>`;

        senders.forEach((s) => {
          if (!s) return;

          select.innerHTML += `<option value="${s}">${s}</option>`;
        });
      }

      /* ================= REALTIME ================= */

      function realtime() {
        supabase
          .channel("orders-channel")
          .on(
            "postgres_changes",
            { event: "*", schema: "public", table: "orders" },
            (payload) => {
              console.log("Realtime:", payload);

              const newRow = payload.new;
              const oldRow = payload.old;

              switch (payload.eventType) {
                case "INSERT":
                  window.orders.unshift(newRow);
                  break;

                case "UPDATE":
                  const index = window.orders.findIndex(
                    (o) => o.id === newRow.id,
                  );

                  if (index !== -1) {
                    window.orders[index] = newRow;
                  }
                  break;

                case "DELETE":
                  window.orders = window.orders.filter(
                    (o) => o.id !== oldRow.id,
                  );
                  break;
              }

              applyFilters(); // render l·∫°i table + stats
            },
          )
          .subscribe();
      }

      /* ================= RENDER ================= */
      const columnMap = {
        ma_van_don: "M√£ v·∫≠n ƒë∆°n",
        trang_thai: "Tr·∫°ng th√°i",
        ten_nguoi_nhan: "Ng∆∞·ªùi nh·∫≠n",
        sdt: "SƒêT",
        dia_chi: "ƒê·ªãa ch·ªâ",
        cod: "Ti·ªÅn COD",
        ten_nguoi_gui: "Kho g·ª≠i",
        thoi_gian_tao_don: "Th·ªùi gian t·∫°o ƒë∆°n",
        created_at: "Ng√†y l∆∞u h·ªá th·ªëng",
      };

      function renderTable() {
        const table = document.getElementById("table");

        if (filteredOrders.length === 0) {
          table.innerHTML = "<tr><td>Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>";
          return;
        }

        const start = (currentPage - 1) * PAGE_SIZE;
        const pageData = filteredOrders.slice(start, start + PAGE_SIZE);

        let html = `<thead class="table-dark"><tr>`;

        Object.keys(pageData[0]).forEach((key) => {
          if (key !== "id") {
            html += `<th>${columnMap[key] || key}</th>`;
          }
        });

        html += "</tr></thead><tbody>";

        pageData.forEach((row) => {
          html += "<tr>";

          Object.entries(row).forEach(([k, v]) => {
            if (k === "id") return;

            // format COD
            if (k === "cod") {
              v = Number(v || 0).toLocaleString() + " ƒë";
            }

            // format date
            if (k.includes("time") || k.includes("created")) {
              v = v ? new Date(v).toLocaleString("vi-VN") : "";
            }

            // badge tr·∫°ng th√°i
            if (k === "trang_thai") {
              let color = "secondary";

              if (v?.includes("ƒê√£ giao")) color = "success";
              else if (v?.includes("ƒêang")) color = "warning";
              else if (v?.includes("Ho√†n")) color = "danger";

              v = `<span class="badge bg-${color}">${v}</span>`;
            }

            html += `<td>${v ?? ""}</td>`;
          });

          html += "</tr>";
        });

        html += "</tbody>";

        table.innerHTML = html;
      }

      function renderStats(data) {
        document.getElementById("totalOrders").innerText = data.length;

        const totalCOD = data.reduce((sum, o) => sum + Number(o.cod || 0), 0);

        document.getElementById("totalCOD").innerText =
          totalCOD.toLocaleString() + " ƒë";
      }

      /* ================= UPLOAD ================= */

      document
        .querySelector(".upload-box")
        .addEventListener("click", () =>
          document.getElementById("upload").click(),
        );

      document
        .getElementById("upload")
        .addEventListener("change", handleUpload);

      async function handleUpload(e) {
        const file = e.target.files[0];

        if (!file) return;

        const buffer = await file.arrayBuffer();

        const workbook = XLSX.read(buffer);

        const sheet = workbook.Sheets[workbook.SheetNames[0]];

        const rows = XLSX.utils.sheet_to_json(sheet);

        const formatted = rows.map((r) => ({
          ma_van_don: r["M√£ v·∫≠n ƒë∆°n"],
          ten_nguoi_nhan: r["T√™n ng∆∞·ªùi nh·∫≠n"],
          sdt: r["SƒêT ng∆∞·ªùi nh·∫≠n"],
          dia_chi: r["ƒê·ªãa ch·ªâ ng∆∞·ªùi nh·∫≠n"],
          cod: r["Ti·ªÅn thu h·ªô COD"] || 0,
          trang_thai: normalizeStatus(r["Tr·∫°ng th√°i v·∫≠n ƒë∆°n"]),
          ten_nguoi_gui: (r["T√™n ng∆∞·ªùi g·ª≠i"] || "").trim(),
          thoi_gian_tao_don: r["Th·ªùi gian t·∫°o ƒë∆°n"]
            ? new Date(r["Th·ªùi gian t·∫°o ƒë∆°n"])
            : new Date(),
        }));

        const { error } = await supabase.from("orders").upsert(formatted, {
          onConflict: "ma_van_don",
        });

        if (error) {
          alert(error.message);
          return;
        }

        alert("Upload th√†nh c√¥ng üöÄ");
      }

      function normalizeStatus(s) {
        s = (s || "").trim().toLowerCase();

        if (s.includes("giao th√†nh c√¥ng")) return "Giao th√†nh c√¥ng";

        if (s.includes("ƒëang giao")) return "ƒêang giao h√†ng";

        if (s.includes("l·∫•y h√†ng")) return "ƒê√£ l·∫•y h√†ng";

        if (s.includes("chuy·ªÉn ho√†n")) return "Chuy·ªÉn ho√†n";

        if (s.includes("h·ªßy")) return "H·ªßy";

        if (s.includes("v·∫•n ƒë·ªÅ")) return "Ki·ªán v·∫•n ƒë·ªÅ";

        return s;
      }
    </script>
  </body>
</html>
